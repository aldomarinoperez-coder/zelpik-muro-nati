<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Zelpik - Muro de Nati</title>
    <script src="/socket.io/socket.io.js"></script>
    <style>
        :root {
            --dorado: #d4af37; --negro: #1a1a1a; --blanco: #ffffff;
            --font-principal: 'Arial Rounded MT Bold', 'Helvetica Rounded', Arial, sans-serif;
        }
        body, html {
            margin: 0; padding: 0; width: 100%; height: 100%;
            background-color: var(--negro); color: var(--blanco);
            font-family: var(--font-principal); overflow: hidden;
            display: flex; flex-direction: column; align-items: center;
        }
        .main-title {
            margin-top: 40px; font-size: 5rem; color: var(--dorado);
            text-shadow: 3px 3px 15px rgba(212, 175, 55, 0.3); z-index: 20;
        }
        .flower { position: absolute; width: 400px; z-index: 10; pointer-events: none; }
        .top-left { top: 0; left: 0; }
        .bottom-right { bottom: 0; right: 0; }

        #content-area { flex-grow: 1; width: 100%; display: flex; justify-content: center; align-items: center; z-index: 15; }
        .slide { position: absolute; display: none; flex-direction: column; justify-content: center; align-items: center; }
        .active { display: flex; animation: fadeIn 1s ease-in-out forwards; }

        #qr-img { width: 400px; border: 15px solid white; border-radius: 10px; box-shadow: 0 0 50px rgba(212, 175, 55, 0.4); }
        
        .foto-frame {
            background: white; padding: 20px; border-radius: 10px;
            box-shadow: 0 30px 60px rgba(0,0,0,0.8); transform: rotate(-1deg);
            width: 80vh; height: 60vh; display: flex; justify-content: center; align-items: center;
        }
        .foto-frame img { max-width: 100%; max-height: 100%; object-fit: contain; }

        .bubble { 
            background: var(--blanco); 
            padding: 60px 100px; 
            border-radius: 80px; 
            border: 12px solid var(--dorado);
            max-width: 80%;
            box-shadow: 0 20px 50px rgba(0,0,0,0.5);
        }
        .bubble h3 { 
            font-size: 4.5rem; 
            color: var(--negro); 
            margin: 0; 
            line-height: 1.2;
            text-align: center;
            font-weight: bold;
            font-family: var(--font-principal);
        }

        @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }
    </style>
</head>
<body>

    <img src="flor-top.png" class="flower top-left">
    <img src="flor-bottom.png" class="flower bottom-right">

    <h1 class="main-title">15 AÑOS NATI</h1>

    <div id="content-area">
        <div id="slide-qr" class="slide active">
            <h2>Escaneá y subí tu foto</h2>
            <img src="qr.png" id="qr-img">
        </div>
        <div id="slide-foto" class="slide">
            <div class="foto-frame"><img src="" id="display-foto"></div>
        </div>
        <div id="slide-texto" class="slide">
            <div class="bubble"><h3 id="display-texto"></h3></div>
        </div>
    </div>

    <script>
        const socket = io();
        const slides = { 
            qr: document.getElementById('slide-qr'), 
            foto: document.getElementById('slide-foto'), 
            texto: document.getElementById('slide-texto') 
        };
        const imgDisplay = document.getElementById('display-foto');
        const txtDisplay = document.getElementById('display-texto');
        
        let fotosHistorial = [];
        let indiceCarrusel = -1; 
        let timerCarrusel;

        // --- CONFIGURACIÓN DE TIEMPOS ---
        const tiempoFotos = 8000;  // 8 segundos para cada foto
        const tiempoQR = 20000;    // 20 segundos para el QR gigante
        // --------------------------------

        function switchSlide(nombre) {
            Object.values(slides).forEach(s => s.classList.remove('active'));
            slides[nombre].classList.add('active');
        }

        function cargarFotos() {
            fetch('/fotos-existentes')
                .then(res => res.json())
                .then(data => {
                    fotosHistorial = data;
                    ejecutarPasoCarrusel(); // Iniciar el motor
                });
        }

        function ejecutarPasoCarrusel() {
            clearTimeout(timerCarrusel);

            if (fotosHistorial.length === 0) {
                switchSlide('qr');
                timerCarrusel = setTimeout(ejecutarPasoCarrusel, tiempoQR);
            } else {
                indiceCarrusel++;
                
                if (indiceCarrusel >= fotosHistorial.length) {
                    // Toca mostrar el QR
                    indiceCarrusel = -1;
                    switchSlide('qr');
                    timerCarrusel = setTimeout(ejecutarPasoCarrusel, tiempoQR); // USA TIEMPO LARGO
                } else {
                    // Toca mostrar una foto
                    imgDisplay.src = fotosHistorial[indiceCarrusel];
                    switchSlide('foto');
                    timerCarrusel = setTimeout(ejecutarPasoCarrusel, tiempoFotos); // USA TIEMPO CORTO
                }
            }
        }

        socket.on('nuevo_contenido', (data) => {
            clearTimeout(timerCarrusel); // Pausamos el carrusel
            
            if (data.tipo === 'foto') {
                fotosHistorial.push(data.url);
                imgDisplay.src = data.url;
                switchSlide('foto');
            } else {
                txtDisplay.innerText = data.mensaje;
                switchSlide('texto');
            }

            // Después de 10 segundos de lo nuevo, retomamos el carrusel normal
            setTimeout(ejecutarPasoCarrusel, 10000);
        });

        cargarFotos();
    </script>
</body>
</html>